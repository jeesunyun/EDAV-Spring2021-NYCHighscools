# Data transformation

Describe the process of getting the data into a form in which you could work with it in R. If your code does not lend itself to being including in the .Rmd  file, provide a link to the folder or file(s) that contain(s) that code.

(suggested: approximately 1/2 page)


```{r, message=FALSE}
# load packages
library(tidyverse)
library(stringr)
library(table1)
```

## Data preparation for high school directory data and demographics join
```{r, message=FALSE}
# read in the datasets
hs_demo <- read_csv("datasets/hs_demo.csv");
hs_dir.2020 <- read_csv("datasets/2020_doe_hs_dir.csv");
hs_dir.2019 <- read_csv("datasets/2019_doe_hs_dir.csv")
```

### Demographics data
```{r}
names(hs_demo)[grepl("Grade", names(hs_demo))];
unique(hs_demo["Year"])
```

We can see that the data contains data not only for high school, and the column names are difficult to retract due to spaces and special characters.
```{r}
# rename names easy to retract
names(hs_demo) <- str_replace_all(names(hs_demo), c(" "="_",  "%"="pct", "#"="n"))
head(names(hs_demo))
```

We don't want schools that are not high schools; the grade range is different per school, so we filter out schools that do not have grades 10, 11, and 12. Then, create new columns that contain population counts for high school grades and non-highschool grades.
Here, we set for high school to be from grades 9 to 12, according to [New York city Department of Education description](https://www.schools.nyc.gov/enrollment/enroll-grade-by-grade/high-school). It is given that students in their 8th grade apply to high schools. We assume that schools that have grades 6 to 12, or K to 12, etc. have continuing students.

Also, the dataset consists of information ranging from school years 2015 to 2019. We want to filter out years other than 2019 for initial processing of the data since the directory data are for 2019-2020.
```{r}
# we dont want schools that are not high schools
# create a new column that would contain enrollment for only those from Grade 9(hs) and other

hs_demo_tidy <- hs_demo %>% 
  mutate(hs_enroll = Grade_9 + Grade_10 + Grade_11 + Grade_12,
         non_hs = rowSums(hs_demo[6:14]),
         PK = `Grade_3K+PK_(Half_Day_&_Full_Day)`) %>%
    dplyr::filter(Grade_9 != 0 & Year == "2019-20") %>% 
  dplyr::select(DBN, School_Name, Year, Total_Enrollment, hs_enroll, non_hs, everything(), -`Grade_3K+PK_(Half_Day_&_Full_Day)`) %>%
  dplyr::filter( Grade_10 !=0 & Grade_11 !=10 & Grade_12 != 0 )

```

### High school directory data
```{r}
dim(hs_dir.2019)
```

The directory data has very extensive information each schools, from basic school information to detailed descriptions of each program and admission information.
However, we do not want more than 400 variables, so we select only the information relevant and informative to us.
Such variables are: basic school information(DBN, school name, neighborhood) to characteristic information(programs, statistics, admissions).

The directory data has very extensive information each schools, from basic school information to detailed descriptions of each program and admission information.
However, we do not want more than 400 variables, so we select only the information relevant and informative to us.
Such variables are: basic school information(DBN, school name, neighborhood) to characteristic information(programs, statistics, admissions).

*Also, the programs take up many columns, so we can concatenate them into a single column of lists?*

```{r}
hs_dir_tidy.2019 <- hs_dir.2019 %>% 
    dplyr::select(dbn, school_name, Borough, neighborhood, total_students, grades2018, finalgrades, program1, program2,program3,
                program4, program5, program6, program7, program8, program9, program10,
                language_classes, advancedplacement_courses, diplomaendorsements,graduation_rate,
                attendance_rate, pct_stu_enough_variety, college_career_rate, specialized, 
                admissionspriority11, admissionspriority21
                )
```

### Join data
Since we have the names and the DBN which are unique, we join the two datasets using these columns as indicators.

```{r}
hs_join.2019 <- hs_dir_tidy.2019 %>% 
  left_join(hs_demo_tidy, by = c("dbn" = "DBN"))%>% 
  dplyr::select(dbn, school_name, neighborhood, total_students, Total_Enrollment, hs_enroll, non_hs, grades2018, PK,
                Grade_K:Grade_12, everything()) %>% 
  mutate(across(where(is.character), ~na_if(., "N/A")))
# change character values indicated "N/A" into NAs
head(hs_join.2019)
```

It is interesting that the total number of students are not equal in both data sets.
```{r}
mismatch.n.19 <- hs_join.2019[which(hs_join.2019$total_students != hs_join.2019$Total_Enrollment), ]; dim(mismatch.n.19)
match.n.19 <- hs_join.2019[which(hs_join.2019$total_students == hs_join.2019$Total_Enrollment), ]; dim(match.n.19)
```
Only 5 schools have total number of students identical in both data sets.
*Which number is safe to use?*
Since demograhic data is based on the total population from hs_demo data, use that?


### Join data
Since we have the names and the DBN which are unique, we join the two datasets using these columns as indicators.

```{r}
hs_join.2019 <- hs_dir_tidy.2019 %>% 
  left_join(hs_demo_tidy, by = c("dbn" = "DBN", "school_name" = "School_Name"))%>% 
  dplyr::select(dbn, school_name, neighborhood, total_students, Total_Enrollment, hs_enroll, non_hs, grades2018, PK,
                Grade_K:Grade_12, everything()) %>% 
  mutate(across(where(is.character), ~na_if(., "N/A")))
# change character values indicated "N/A" into NAs
head(hs_join.2019)
```

It is interesting that the total number of students are not equal in both data sets.
```{r}
mismatch.n.19 <- hs_join.2019[which(hs_join.2019$total_students != hs_join.2019$Total_Enrollment), ]; dim(mismatch.n.19)
match.n.19 <- hs_join.2019[which(hs_join.2019$total_students == hs_join.2019$Total_Enrollment), ]; dim(match.n.19)
```
Only 5 schools have total number of students identical in both data sets.
*Which number is safe to use?*
Since demograhic data is based on the total population from hs_demo data, use that?

```{r}
t(table(hs_join.2019$grades2018))
# shows that schools mostly grades 9 to 1, and 6 to 12

# what kind of charateristics in 6 to 12? See school characteristics
gr6_to_gr12 <- hs_join.2019[which(hs_join.2019$grades2018 == "6 to 12"), ] %>% 
  dplyr::select(-c(neighborhood, hs_enroll, non_hs, PK, Grade_K, Grade_1, Grade_2, Grade_3, Grade_4, Grade_5))

gr9_to_gr12 <- hs_join.2019[which(hs_join.2019$grades2018 == "9 to 12"), ]
<<<<<<< HEAD


# what other characteristics for schools 6 to 10, 6 to 11, 7 to 12, K to 12 ?
# 9 to 14 is 2 years associate degree
```


### High school location data
```{r}
# location dataset for mapping coordinates
hs_location <- hs_dir.2019 %>% 
  dplyr::select(dbn, school_name, Borough, city, zip, Latitude, Longitude, `Census Tract`, nta)
```

# what other characteristics for schools 6 to 10, 6 to 11, 7 to 12, K to 12 ?
# 9 to 14 is 2 years associate degree
```


### High school location data
```{r}
# location dataset for mapping coordinates
hs_location <- hs_dir.2019 %>% 
  dplyr::select(dbn, school_name, Borough, city, zip, Latitude, Longitude, `Census Tract`, nta)
```

```{r}
# for 2020
head(names(hs_dir.2020))

hs_dir_tidy.2020 <- hs_dir.2020 %>% 
  dplyr::select(dbn, school_name, Borough, neighborhood, total_students, grades2019, 
                language_classes, advancedplacement_courses, diplomaendorsements,graduation_rate,
                attendance_rate, pct_stu_enough_variety, college_career_rate, specialized, 
                admissionspriority11, admissionspriority21
                )
```